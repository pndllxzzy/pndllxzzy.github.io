<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <meta name="format-detection" content="telephone=no" />
  <title>Document</title>
  <style>
    *{box-sizing: border-box;-webkit-tap-highlight-color:rgba(255,0,0,0);}
    html,body,ul,button{padding:0;margin:0;}
    ul,li{list-style:none;}
    a{text-decoration:none;}
    html,body{height:100%;}
    input {
      outline: none;
      -webkit-appearance:none;
    }
    html{font-size:90px;}
    body{font-size:.16rem;-webkit-font-smoothing:antialiased;}
    @media screen and (min-width: 321px){
      html{font-size:100px;}
    }
    @media screen and (min-width: 376px){
      html{font-size:110px;}
    }
    @media screen and (min-width: 426px){
      html{font-size:120px;}
    }
    html,body{
      position:relative;
      width:100%;
      height:100%;
      text-align:center;
    }
    img{display:block;}
    /*loader*/
    .layer-loader{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.7);
      z-index:99;
    }
    .loader-box{
      position:absolute;
      left:50%;
      top:50%;
      padding: 0.1rem;
      margin-top:-0.22rem;
      margin-left:-0.22rem;
      border-radius:0.1rem;
      -webkit-border-radius:0.1rem;
      background:rgba(255,255,255,.7);
    }
    .preloader {
      width: 0.34rem;
      height: 0.34rem;
      -webkit-transform-origin: 50%;
      transform-origin: 50%;
      -webkit-animation: preloader-spin 1s steps(12, end) infinite;
      animation: preloader-spin 1s steps(12, end) infinite;
    }
    .preloader:after {
      display: block;
      content: "";
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg%20viewBox%3D'0%200%20120%20120'%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20xmlns%3Axlink%3D'http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink'%3E%3Cdefs%3E%3Cline%20id%3D'l'%20x1%3D'60'%20x2%3D'60'%20y1%3D'7'%20y2%3D'27'%20stroke%3D'%236c6c6c'%20stroke-width%3D'11'%20stroke-linecap%3D'round'%2F%3E%3C%2Fdefs%3E%3Cg%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.27'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.27'%20transform%3D'rotate(30%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.27'%20transform%3D'rotate(60%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.27'%20transform%3D'rotate(90%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.27'%20transform%3D'rotate(120%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.27'%20transform%3D'rotate(150%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.37'%20transform%3D'rotate(180%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.46'%20transform%3D'rotate(210%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.56'%20transform%3D'rotate(240%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.66'%20transform%3D'rotate(270%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.75'%20transform%3D'rotate(300%2060%2C60)'%2F%3E%3Cuse%20xlink%3Ahref%3D'%23l'%20opacity%3D'.85'%20transform%3D'rotate(330%2060%2C60)'%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E");
      background-position: 50%;
      background-size: 100%;
      background-repeat: no-repeat;
    }
    @-webkit-keyframes preloader-spin {
      100% {
        -webkit-transform: rotate(360deg);
      }
    }
    @keyframes preloader-spin {
      100% {
        -webkit-transform: rotate(360deg);
        transform: rotate(360deg);
      }
    }
    /*loader*/
    .title{
      margin-top:.1rem;
      color:#fff;
      font-size:.2rem;
    }
    #imgUser{
      width:100%;
      height:100%;
    }
    #btnLoadFile{
      display:block;
      width:100%;
      height:100%;
      opacity:0;
    }
    #btnCreateImg{
      position:absolute;
      left:10%;
      bottom:5%;
      width:80%;
      line-height:.5rem;
      background-color:#04BE02;
      color:#fff;
      -webkit-border-radius: 5px;
      border-radius: 5px;
    }
    #bgImg{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      z-index:2;
    }
    #imgCanvas{
      width:100%;
    }
    #txtInput{
      width:100%;
      padding:0;
      border:0;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      background-color: rgba(0,0,0,0);
      color:#fff;
      text-align:center;
      font-family: Tahoma,Helvetica,Arial,sans-serif;
    }
    .container,.area-img,#imgCanvas,.area-file,.area-text,.area-avatar,.area-result,.tips-change-img{
      position:absolute;
      width:100%;
      height:100%;
      top:0;
      left:0;
      z-index:1;
    }
    #imgCanvas{
      display:none;
      height:auto;
    }
    .area-img{
      z-index:-1;
    }
    .container{
      overflow: hidden;
      z-index:2;
    }
    .area-file{
      z-index:3;
    }
    .placeholder,#txtInput{
      line-height:1;
      font-size:20px;
    }
    .placeholder{
      position:absolute;
      width:100%;
      z-index:-1;
    }
    .area-text {
      width:100%;
      height:20px;
      color:#fff;
      text-align:center;
    }
    #imgResult{
      width:100%;
    }
    .area-result{
      transform: scale(0, 0) rotateY(1080deg);
      -webkit-transform: scale(0, 0) rotateY(1080deg);
      transition: transform 1s;
      -webkit-transition: -webkit-transform 1s;
    }
    .normal{
      transform: scale(1, 1) rotateY(0deg);
      -webkit-transform: scale(1, 1) rotateY(0deg);
    }
    .tips-change-img{
      padding-top:.1rem;
      line-height:.2rem;
      text-align:center;
      background:rgba(255,255,255,.5)
    }
    .canvasContainer{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      z-index:9;
    }
    .tips-cut{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: .5rem;
      text-align: center;
      z-index: 10000;
      color: #fff;
      font-size: .2rem;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="title">图片生成器</div>
  <div class="area-file compute" data-position='{"base":750,"top":608,"left":285,"width":173,"height":127}'>
    <input type="file" id="btnLoadFile"/>
  </div>
  <div class="area-text compute" data-position='{"base":750,"top":208}'>
    <div class="placeholder">输入文字</div>
    <input id="txtInput" />
  </div>
  <div id="btnCreateImg">生成我的图片</div>
  <div class="area-img">
    <img id="bgImg" src="../img/bg.png" />
    <div class="area-avatar compute" data-position='{"base":750,"top":608,"left":285,"width":173,"height":127}'>
      <div class="tips-change-img">
        这里可以<br/>换图片
      </div>
      <img id="imgUser" src="../img/bg-avatar.jpg" />
    </div>
  </div>
</div>
<canvas id="imgCanvas" width="750" height="1334"></canvas>
<div class="area-result">
  <img id="imgResult" />
</div>
<div class="canvasContainer">
  <div class="tips-cut">三只手指触碰可截图</div>
</div>
<script src="../js/tools.js"></script>
<script src="../js/ImageEditor.js"></script>
<script src="../js/cutImage.js"></script>
<script>
  var cutImage;
  var clientWidth = document.documentElement.clientWidth;
  var clientHeight = document.documentElement.clientHeight;

  cutImage = new CutImage({
    container: $('.canvasContainer'),
    sizeInfo: {
      w: document.documentElement.clientWidth,
      h: document.documentElement.clientHeight
    },
    cutWindowInfo: {
      x: 0,
      y: (clientHeight - clientWidth * 127 / 173) / 2,
      width: clientWidth,
      height: clientWidth * 127 / 173
    },
    threeTouchCB: function(){
      $('#imgUser').src = cutImage.getCutUrlData();
      $('.canvasContainer').style.display = 'none';
    }
  });
  cutImage.init();

  [].forEach.call($('.compute'), function(el){
    tools.compute(el);
  });

  $('#imgCanvas').height = 750 / clientWidth * clientHeight;

  tools.loadFile({
    inputFile: $('#btnLoadFile'),
    callback: function(res){
      var img = new Image();

      img.onload = function(){
        cutImage.loadImage(img, true);
        $('.canvasContainer').style.display = 'block';
      };
      img.src = res;
    }
  });

  $('#txtInput').addEventListener('focus', function(){
    $('.placeholder').style.display = 'none';
  });

  $('#txtInput').addEventListener('blur', function(){
    if(this.value.trim() == ''){
      $('.placeholder').style.display = 'block';
    }
  });

  $('#btnCreateImg').addEventListener('click', function(){
    tools.showLoader();
    $('#imgResult').src = draw();
    $('.area-result').className += ' normal';
    $('.container').style.display = 'none';
    tools.hideLoader();
  });

  function draw(){
    var canvas = $('#imgCanvas');
    var ctx = canvas.getContext('2d');

    ctx.drawImage($('#imgUser'), 285, 608, 173, 127);
    ctx.drawImage($('#bgImg'), 0, 0, 750, 1334);
    ctx.font = 750 / document.documentElement.clientWidth * 20 + "px Tahoma,Helvetica,Arial,sans-serif";
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.fillText($('#txtInput').value.trim(), canvas.width / 2, 208 + 750 / document.documentElement.clientWidth * 20);

    return canvas.toDataURL('image/png');
  }
</script>
</body>
</html>